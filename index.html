<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEP ë¡œê·¸ì¸ Test</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-pills card-header-pills" id="authTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="login-tab" data-bs-toggle="pill" data-bs-target="#login" type="button" role="tab">ë¡œê·¸ì¸</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="signup-tab" data-bs-toggle="pill" data-bs-target="#signup" type="button" role="tab">íšŒì›ê°€ì…</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="authTabContent">
                            <!-- ë¡œê·¸ì¸ í¼ -->
                            <div class="tab-pane fade show active" id="login" role="tabpanel">
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="loginEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                                        <input type="password" class="form-control" id="loginPassword" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">ë¡œê·¸ì¸</button>
                                </form>
                            </div>
                            
                            <!-- íšŒì›ê°€ì… í¼ -->
                            <div class="tab-pane fade" id="signup" role="tabpanel">
                                <form id="signupForm">
                                    <div class="mb-3">
                                        <label for="signupEmail" class="form-label">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="signupEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="signupPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                                        <input type="password" class="form-control" id="signupPassword" minlength="4" maxlength="20" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="signupPasswordConfirm" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                        <input type="password" class="form-control" id="signupPasswordConfirm" minlength="4" maxlength="20" required>
                                        <div class="invalid-feedback" id="passwordMismatchError">
                                            ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="signupName" class="form-label">ì´ë¦„</label>
                                        <input type="text" class="form-control" id="signupName" maxlength="10" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="signupProfileImage" class="form-label">í”„ë¡œí•„ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</label>
                                        <input type="file" class="form-control" id="signupProfileImage" accept="image/*">
                                        <div class="form-text">JPG, PNG, GIF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 10MB)</div>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100">íšŒì›ê°€ì…</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ì—­ (ë¡œê·¸ì¸ í›„) -->
                <div class="card mt-3" id="userInfo" style="display: none;">
                    <div class="card-body text-center">
                        <div class="profile-image-container mb-3" style="width: 80px; height: 80px; margin: 0 auto; position: relative;">
                            <img id="userProfileImage" src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover; display: none; position: absolute;">
                            <div id="defaultProfileIcon" class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; position: absolute;">
                                <i class="text-white" style="font-size: 2rem;">ğŸ‘¤</i>
                            </div>
                        </div>
                        <h5 class="card-title">í™˜ì˜í•©ë‹ˆë‹¤!</h5>
                        <p class="card-text" id="userNameDisplay"></p>
                        <p class="card-text small text-muted" id="userEmailDisplay"></p>
                        <button class="btn btn-outline-danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
                
                <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
                <div id="alertContainer" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8080/api/auth';
        
        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
        
        // ë¡œê·¸ì¸ í¼ ì²˜ë¦¬
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    const userData = result.data;
                    console.log('ë¡œê·¸ì¸ ì‘ë‹µ ë°ì´í„°:', userData); // ë””ë²„ê¹…ìš©
                    
                    document.getElementById('userNameDisplay').textContent = `${userData.name}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;
                    document.getElementById('userEmailDisplay').textContent = userData.email;
                    
                    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì²˜ë¦¬
                    const profileImage = document.getElementById('userProfileImage');
                    const defaultIcon = document.getElementById('defaultProfileIcon');
                    
                    console.log('í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ:', userData.profileImagePath); // ë””ë²„ê¹…ìš©
                    
                    if (userData.profileImagePath) {
                        const imageUrl = `http://localhost:8080/uploads/profiles/${userData.profileImagePath}`;
                        console.log('ì´ë¯¸ì§€ URL:', imageUrl); // ë””ë²„ê¹…ìš©
                        
                        profileImage.onload = function() {
                            console.log('ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ');
                            profileImage.style.display = 'block';
                            profileImage.style.zIndex = '2';
                            defaultIcon.style.display = 'none';
                        };
                        
                        profileImage.onerror = function() {
                            console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ');
                            profileImage.style.display = 'none';
                            defaultIcon.style.display = 'flex';
                            defaultIcon.style.zIndex = '1';
                        };
                        
                        profileImage.src = imageUrl;
                    } else {
                        console.log('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤'); // ë””ë²„ê¹…ìš©
                        profileImage.style.display = 'none';
                        defaultIcon.style.display = 'flex';
                    }
                    
                    document.getElementById('userInfo').style.display = 'block';
                    document.querySelector('.card').style.display = 'none';
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showAlert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                console.error('Login error:', error);
            }
        });
        
        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì‹¤ì‹œê°„ ê²€ì¦
        document.getElementById('signupPasswordConfirm').addEventListener('input', function() {
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = this.value;
            const errorDiv = document.getElementById('passwordMismatchError');
            
            if (passwordConfirm && password !== passwordConfirm) {
                this.classList.add('is-invalid');
                errorDiv.style.display = 'block';
            } else {
                this.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
            }
        });
        
        // íšŒì›ê°€ì… í¼ ì²˜ë¦¬
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const name = document.getElementById('signupName').value;
            const profileImageFile = document.getElementById('signupProfileImage').files[0];
            
            // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
            if (password !== passwordConfirm) {
                showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('email', email);
            formData.append('password', password);
            formData.append('passwordConfirm', passwordConfirm);
            formData.append('name', name);
            if (profileImageFile) {
                formData.append('profileImage', profileImageFile);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/signup-with-image`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    document.getElementById('signupForm').reset();
                    // ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                    document.getElementById('login-tab').click();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showAlert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                console.error('Signup error:', error);
            }
        });
        
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });git
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'info');
                    document.getElementById('userInfo').style.display = 'none';
                    document.querySelector('.card').style.display = 'block';
                    document.getElementById('loginForm').reset();
                }
            } catch (error) {
                showAlert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                console.error('Logout error:', error);
            }
        });
    </script>
</body>
</html>